# やりたいこと

gpencil のストロークのポイント数を、フレーム間・同インデックスで最大数に一致させる

# 目的

gpencil のストロークを補間する機能で中割を生成できるが、
本来この機能は同一ストロークを変形させたものを補間することを想定しているので、
単純にポイント番号が同じポイントを補間するように機能する（シェイプキーみたいな挙動）

これをフリーハンドで書いたストローク同士を補間するとポイント数が違うので、
生成させる中割はポイント数が少ないものに準拠して適当にポイントが切り捨てられるため、短くなる

このポイント数を一致させることによってフリーハンドのストローク同士の中割りをいい感じに生成できるようにしたい。

# 実装時に使いそうな情報とか

## gpencil のデータ構造メモ

```python
bpy.context.active_object.data = bpy.data.grease_pencils['Stroke']
```

```python
bpy.data.grease_pencils['Stroke'] = {
    layers[int or "name"]:{
        select:bool,
        info:"name",
        frames[int]:{
            select:bool,
            frame_number:int,
            strokes[int]:{
                select:bool,
                points[int]:{
                    select:bool,
                    co:(x,y,z)
                }
            }
        }
    }
}
```

# 必要そうな機能

## 済　任意ポイント数でストロークをリサンプリングする機能

幸い`bpy.ops.gpencil.stroke_sample()`を使うと、ストロークを任意のセグメント長でサンプリングできる

### bpy.ops.gpencil.stroke_sample()の挙動

ある点 A からソースストロークをなぞっていき、ソースストローク上の長さがサンプリング長と一致したところで点 B をプロット、
これを終了点まで繰り返す感じ
ただし、開始点と終了点は固定でソースと変わらない
このときできたセグメント長はサンプリング長と一致しない
　この仕様のためダウンサンプリングだと致命的にポイント数を合せにくいが、
アップサンプリングでは大体近い数字になる
この辺どうにかしたいけどどうしようかな

ポイント数の誤差はもしかすると演算誤差の蓄積によるものかもしれない
なので事前にオフセットを作ってサンプル長に加算しておくと良いかも　要検証

> 演算誤差ではなさそう。とりあえず「ポイント数-1.5」した値で割ると安定した結果になることがわかったので、ここまでとする。

済

- 現在のフレーム以後次のフレームより前の gp_frame に対して処理を実行してるみたい
- なので活用するには現在のフレームの保存、設定をできるようにする必要がある

### Input

```
stroke: bpy.types.GPencilStroke
point_count: int
```

## 済　ストロークの長さを計算する機能

### Input

`stroke: bpy.types.GPencilStroke`

これは出来てるが機能分割しようかな

## レイヤのポイント数を一括取得

上記から分割する

## 条件に一致する最も大きいポイント数を取得

条件はこんな感じで

- すべてのフレームか
- すべてのストロークか
- 選択フレームか
- 選択ストロークか

## 済　選択状態のセーブロード機能

選択状態の保存、読み込み、ついでに選択状態に応じた関数呼出しとかできたらいいよな

### シーンの現在のフレームのセーブロードもする

`bpy.context.scene.frame_current` ここから直接取得設定できる

## ストロークをインデックス順に色付けする機能

ストロークの順番を可視化するモードがあると作画する時に便利かもしれないのでやってみよう

### 差分更新メモ

差分更新しようとしてつまずいたのでメモ

色の変更がないストロークを更新しないようにするために色を比較すると微妙に誤差が出ていた
もしかして頂点カラーに入ってる値って fp32 じゃなくて fp16 だったりするのかな

逆だ、python の float が float64 で blender の float が float32 だった

### ストロークの分割についてメモ

ストロークの分割、例えば有るストローク A を真ん中で両断して 2 つのストロークができるときの話

このとき、ストロークの開始・終了点側のストローク A'・B ができる

A'は A と同じインデックスを持つ

B は A の 1 つあとのインデックスを持つ
